// Generated by CoffeeScript 1.6.1
(function() {
  var _this = this;

  app.checkout = {
    init: function($element) {
      this.el = $element;
      this.readyToBuy = false;
      return this.eventListeners();
    },
    eventListeners: function() {
      var that;
      that = this;
      app.validator.init(this.el);
      this.el.find('.js-next').click(function(e) {
        e.preventDefault();
        if (that.el.valid()) {
          return that.showConfirm();
        }
      });
      this.el.find('.js-prev').click(function(e) {
        e.preventDefault();
        return that.showForm();
      });
      this.el.submit(function(e) {
        e.preventDefault();
        if (that.el.valid()) {
          return that.createToken();
        } else {
          return that.showForm();
        }
      });
      $(document).keypress(function(e) {
        if (e.which === 13) {
          e.preventDefault();
          return that.nextAction();
        }
      });
      return this.el.find('#card-holdername').one('focus', function(e) {
        var $this, validShippingName;
        $this = $(this);
        if ($this.val().length === 0) {
          validShippingName = that.el.find('#order-name.is-valid').val();
          return $this.val(validShippingName);
        }
      });
    },
    showConfirm: function(e) {
      this.enterConfirmData();
      this.el.find('.js-checkoutForm').addClass('u-isHidden');
      this.el.find('.js-checkoutConfirm').removeClass('u-isHidden');
      return this.readyToBuy = true;
    },
    showForm: function(e) {
      this.el.find('.js-checkoutForm').removeClass('u-isHidden');
      this.el.find('.js-checkoutConfirm').addClass('u-isHidden');
      return this.readyToBuy = false;
    },
    nextAction: function(e) {
      if (this.readyToBuy) {
        return this.el.find('.js-buy').click();
      } else {
        return this.el.find('.js-next').click();
      }
    },
    enterConfirmData: function(e) {
      var cardNumber, cardType, firstDigets;
      $('#confirm-name').text(this.el.find("#order-name").val());
      $('#confirm-email').text(this.el.find("#order-email").val());
      $('#confirm-country').text(this.el.find("#order-country").val());
      $('#confirm-street').text(this.el.find("#order-street").val());
      $('#confirm-city').text(this.el.find("#order-city").val());
      $('#confirm-postalCode').text(this.el.find("#order-postalCode").val());
      cardNumber = this.el.find("#card-number").val();
      firstDigets = cardNumber.substr(0, 5);
      cardType = $.payment.cardType(cardNumber);
      cardType = cardType.charAt(0).toUpperCase() + cardType.slice(1);
      $('#confirm-cardNumber').text(firstDigets);
      return $('#confirm-cardType').text(cardType);
    },
    createToken: function(e) {
      this.el.find('[name*=card]').removeAttr('name');
      return paymill.createToken({
        number: this.el.find("#card-number").val(),
        exp_month: this.el.find("#card-expiry").payment('cardExpiryVal').month,
        exp_year: this.el.find("#card-expiry").payment('cardExpiryVal').year,
        cvc: this.el.find("#card-cvc").val(),
        cardholder: this.el.find("#card-holdername").val(),
        amount_int: this.el.find("#card-amountInt").val(),
        currency: this.el.find("#card-currency").val()
      }, this.PaymillResponseHandler);
    },
    PaymillResponseHandler: function(error, result) {
      var that;
      that = window.app.checkout;
      if (error) {
        console.log("Error: ", error);
        alert("Something went wrong :(");
        return that.showForm();
      } else {
        console.log("Result: ", result);
        that.el.find(".token").remove();
        that.el.append("<input type='hidden' name='order[token]' class='token' value='" + result.token + "'/>");
        return that.el.get(0).submit();
      }
    }
  };

}).call(this);
